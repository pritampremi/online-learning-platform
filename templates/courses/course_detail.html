{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
    <h2>{{ course.title }}</h2>
    <p>{{ course.description }}</p>
    <p><strong>Category:</strong> {{ course.category }}</p>
    <p><strong>Price:</strong> ‚Çπ{{ course.price }}</p>

    {% if course.thumbnail %}
        <img src="{{ course.thumbnail.url }}" alt="{{ course.title }}" class="img-fluid mb-3" style="max-height: 200px;">
    {% endif %}

    <hr>

    {% if is_instructor %}
        <a href="{% url 'courses:add_module' course.id %}" class="btn btn-success mb-3">
            <i class="bi bi-plus-circle"></i> Add Module
        </a>

        <a href="{% url 'courses:create_quiz' course.id %}" class="btn btn-outline-secondary mb-3 ms-4">
        <i class="bi bi-plus-square"></i> Create Quiz
        </a>

        <a href="{% url 'courses:instructor_quizzes' course.id %}" class="btn btn-outline-info mb-3 ms-4">
            Manage Quizzes
        </a>
    {% endif %}



    {% if is_student %}
    {% if not is_enrolled %}
        <a href="{% url 'courses:checkout' course.id %}" class="btn btn-success mb-2">
            Enroll Now (‚Çπ{{ course.price }})
        </a>
    {% else %}
        <span class="badge bg-success">Enrolled</span>

        <div class="progress mb-3 mt-3" style="height: 24px;">
        <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress_percent }}%;" aria-valuenow="{{ progress_percent }}" aria-valuemin="0" aria-valuemax="100">
            {{ progress_percent }}%
        </div>
        </div>

        {% if progress_percent == 100 %}
            <a href="{% url 'courses:download_certificate' course.id %}" class="btn btn-outline-primary">
                üèÖ Download Certificate
            </a>
        {% endif %}
    
    {% endif %}
    {% endif %}

    <h4>Modules</h4>

    {% for module in modules %}
        <div class="mb-4">
            <h5>{{ module.order }}. {{ module.title }}</h5>

            {% if is_instructor %}
                <a href="{% url 'courses:add_lesson' module.id %}" class="btn btn-sm btn-outline-primary mb-2">
                    <i class="bi bi-plus-circle"></i> Add Lesson
                </a>
                <a href="{% url 'courses:edit_module' module.id %}" class="btn btn-sm btn-outline-warning mb-2">
                    <i class="bi bi-pencil"></i> Edit Module
                </a>
                <a href="{% url 'courses:delete_module' module.id %}" class="btn btn-sm btn-outline-danger mb-2">
                    <i class="bi bi-trash3"></i> Delete Module
                </a>
            {% endif %}

            <ul class="list-group">
                {% for lesson in module.lessons.all %}
                    <li class="list-group-item">
                        <strong>{{ lesson.order }}. {{ lesson.title }}</strong><br>
                        <small>{{ lesson.content|truncatewords:20 }}</small><br>
                        {% if is_student %}
                        {% if is_enrolled %}
                            <a href="{% url 'courses:lesson_detail' lesson.id %}" class="text-primary">View Lesson</a>
                        {% endif %}
                        {% endif %}
                        

                        {% if is_instructor %}
                            <a href="{% url 'courses:lesson_detail' lesson.id %}" class="text-primary">View Lesson</a>
                            <br>
                            <a href="{% url 'courses:edit_lesson' lesson.id %}" class="btn btn-sm btn-outline-warning mt-2">
                                <i class="bi bi-pencil-square"></i> Edit Lesson
                            </a>

                            <form method="POST" action="{% url 'courses:delete_lesson' lesson.id %}" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger ms-2 mt-2">
                                    <i class="bi bi-trash3"></i> Delete Lesson
                                </button>
                            </form>
                        {% endif %}
                    </li>
                {% empty %}
                    <li class="list-group-item text-muted">No lessons yet.</li>
                {% endfor %}
            </ul>
        </div>
    {% empty %}
        <p>No modules added yet.</p>
    {% endfor %}

{% if is_student %}
{% if is_enrolled %}
    
    {% if quizzes %}
    <h4 class="mt-4 text-warning"><i class="bi bi-patch-question"></i> Quizzes</h4>
    <ul class="list-group mb-2">
        {% for quiz in quizzes %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            {{ quiz.title }}
            <a href="{% url 'courses:attempt_quiz' quiz.id %}" class="btn btn-sm btn-primary">Attempt</a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No quizzes available for this course yet.</p>
    {% endif %}

{% endif %}
{% endif %}

</div>
{% endblock %}
